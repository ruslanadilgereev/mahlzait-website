---
import "swiper/css";
import "@styles/styles.scss";
import type { TemplateConfig } from "utils/configType";
import SpeedInsights from "@vercel/speed-insights/astro";
import Analytics from "@vercel/analytics/astro";
import CookieConsent from "@components/cookieConsent";

const { backgroundGrid, seo, logo, theme, forceTheme } =
  Astro.props as TemplateConfig;

const siteUrl = "https://www.mahlzait.de";
const canonicalUrl = new URL(Astro.url.pathname, siteUrl).href;
const logoFullUrl = new URL(logo, siteUrl).href;
---

<!doctype html>
<html lang="de" data-theme={theme}>
  <head>
    <!-- Global Metadata -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    
    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="shortcut icon" href="/favicon.ico" />
    
    <meta name="generator" content={Astro.generator} />

    <!-- Primary Meta Tags -->
    <title>{seo.title}</title>
    <meta name="title" content={seo.title} />
    <meta name="description" content={seo.description} />
    <meta
      name="keywords"
      content="kalorienzähler, kalorienzähler app, food tracker, kalorienzähler mit ki, kalorienzähler kostenlos, kalorien tracker, mahlzeiten tracken, barcode scanner, rezepte teilen, gewicht tracken, makros tracken, ernährungstagebuch, diät app, abnehmen app, fitness tracker"
    />
    <meta name="author" content="Mahlzait" />
    <meta
      name="robots"
      content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"
    />
    <meta name="theme-color" content="#10b981" />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalUrl} />

    <!-- Alternate hreflang -->
    <link rel="alternate" hreflang="de" href={canonicalUrl} />
    <link rel="alternate" hreflang="de-DE" href={canonicalUrl} />
    <link rel="alternate" hreflang="x-default" href={canonicalUrl} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:site_name" content="Mahlzait" />
    <meta property="og:title" content={seo.title} />
    <meta property="og:description" content={seo.description} />
    <meta property="og:image" content={logoFullUrl} />
    <meta property="og:image:width" content="512" />
    <meta property="og:image:height" content="512" />
    <meta property="og:image:alt" content="Mahlzait Logo" />
    <meta property="og:locale" content="de_DE" />

    <!-- Facebook Domain Verification -->
    <meta name="facebook-domain-verification" content="p9so2b3c3rj97va481ew5bsbvt1yj0" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalUrl} />
    <meta name="twitter:title" content={seo.title} />
    <meta name="twitter:description" content={seo.description} />
    <meta name="twitter:image" content={logoFullUrl} />
    <meta name="twitter:image:alt" content="Mahlzait Logo" />

    <!-- Apple Mobile Web App -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Mahlzait" />
    <link rel="apple-touch-icon" href={logo} />

    <!-- Microsoft -->
    <meta name="msapplication-TileColor" content="#10b981" />
    <meta name="msapplication-tap-highlight" content="no" />

    <!-- Preload kritische Ressourcen -->
    <link
      rel="preload"
      href="/fonts/Rowdies-Bold.ttf"
      as="font"
      type="font/ttf"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/CabinSketch.ttf"
      as="font"
      type="font/ttf"
      crossorigin
    />

    <!-- Prefetch wichtige Seiten -->
    <link rel="prefetch" href="/app" />

    <!-- DNS Prefetch für externe Ressourcen -->
    <link rel="dns-prefetch" href="https://apps.apple.com" />
    <link rel="dns-prefetch" href="https://play.google.com" />
    <!-- Tracking-Scripts werden nur nach Cookie-Consent geladen -->
    <!-- Siehe CookieConsent-Komponente -->

    <!-- AI Discovery Links -->
    <link rel="alternate" type="application/json" href="/api/content.json" title="Structured Data for AI" />
    <link rel="alternate" type="application/json" href="/ai-questions.json" title="AI Questions & Answers" />
    <link rel="alternate" type="application/json" href="/comparison.json" title="App Comparison" />
    <link rel="alternate" type="application/rss+xml" href="/rss.xml" title="RSS Feed" />
    <link rel="manifest" href="/.well-known/ai-plugin.json" />

    <script is:inline define:vars={{ forceTheme }}>
      function getPreferredColorScheme() {
        if (!window.matchMedia) {
          return;
        }
        if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
          return "dark";
        }
      }
      const theme = localStorage.getItem("theme") ?? getPreferredColorScheme();
      if (theme === "dark" && !forceTheme)
        document.documentElement.setAttribute("data-theme", theme);
    </script>

    <!-- Hash Navigation Fix: Scroll nach React Hydration -->
    <script is:inline>
      if (window.location.hash) {
        var hash = window.location.hash;
        // Warte bis React hydrated ist
        setTimeout(function() {
          var el = document.querySelector(hash);
          if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }, 500);
      }
    </script>
  </head>
  <body class="relative">
    {backgroundGrid && <div class="backgroundGrid" />}
    <slot />
    <SpeedInsights />
    <Analytics />
    <CookieConsent client:load />

    <!-- MAXIMUM POWER Analytics & Tracking -->
    <!-- Wird nur ausgeführt, wenn Cookie-Consent für Analytics/Marketing erteilt wurde -->
    <script is:inline>
      document.addEventListener('DOMContentLoaded', function() {
        // Read consent before tracking
        function getConsentPreferences() {
          try {
            const consent = localStorage.getItem('cookie_consent');
            if (!consent) return null;
            const data = JSON.parse(consent);
            return data && data.preferences ? data.preferences : null;
          } catch {
            return null;
          }
        }

        const prefs = getConsentPreferences();
        const analyticsEnabled = !!(prefs && prefs.analytics);
        const marketingEnabled = !!(prefs && prefs.marketing);

        // Only proceed if at least one optional category is enabled
        if (!analyticsEnabled && !marketingEnabled) return;

        // ============ HELPERS ============
        function clarityEvent(e) { if (typeof clarity === 'function') clarity('event', e); }
        function clarityTag(k, v) { if (typeof clarity === 'function') clarity('set', k, v); }
        function gaEvent(name, params) { if (typeof gtag === 'function') gtag('event', name, params); }
        function fbEvent(name, params) { if (typeof fbq === 'function') fbq('track', name, params); }

        // ============ TRAFFIC SOURCE (computed once) ============
        const urlParams = new URLSearchParams(window.location.search);
        const utmSource = urlParams.get('utm_source');
        const utmMedium = urlParams.get('utm_medium');
        const utmCampaign = urlParams.get('utm_campaign');
        const gclid = urlParams.get('gclid');
        const fbclid = urlParams.get('fbclid');

        let trafficSource = 'direct';
        let acquisitionType = 'organic';

        if (gclid) {
          trafficSource = 'google_ads';
          acquisitionType = 'paid';
        } else if (fbclid) {
          trafficSource = 'meta_ads';
          acquisitionType = 'paid';
        } else if (utmSource) {
          trafficSource = utmSource;
          acquisitionType = (utmMedium === 'cpc' || utmMedium === 'paid') ? 'paid' : 'organic';
        } else {
          const ref = document.referrer;
          if (ref.includes('google')) trafficSource = 'google_organic';
          else if (ref.includes('facebook') || ref.includes('instagram')) trafficSource = 'meta_organic';
          else if (ref.includes('tiktok')) trafficSource = 'tiktok';
          else if (ref.includes('youtube')) trafficSource = 'youtube';
          else if (ref) trafficSource = 'referral';
          else trafficSource = 'direct';
          acquisitionType = 'organic';
        }

        // ============ VISITOR IDENTIFICATION ============
        // Only run visitor/session analytics if analytics consent is enabled
        if (analyticsEnabled) {
          // Generate or get visitor ID (analytics only)
          let visitorId = localStorage.getItem('visitor_id');
          if (!visitorId) {
            visitorId = 'v_' + Date.now() + '_' + Math.random().toString(36).slice(2, 11);
            localStorage.setItem('visitor_id', visitorId);
            clarityTag('visitor_type', 'new');
            clarityEvent('new_visitor');
          } else {
            clarityTag('visitor_type', 'returning');
          }
          clarityTag('visitor_id', visitorId);

          // Visit count
          const visitCount = parseInt(localStorage.getItem('visit_count') || '0', 10) + 1;
          localStorage.setItem('visit_count', visitCount.toString());
          clarityTag('visit_count', visitCount <= 1 ? '1_first' : visitCount <= 3 ? '2-3' : visitCount <= 10 ? '4-10' : '10+');

          // Days since first visit
          let firstVisit = localStorage.getItem('first_visit');
          if (!firstVisit) {
            firstVisit = Date.now().toString();
            localStorage.setItem('first_visit', firstVisit);
          }
          const daysSinceFirst = Math.floor((Date.now() - parseInt(firstVisit, 10)) / (1000 * 60 * 60 * 24));
          clarityTag('days_since_first_visit', daysSinceFirst === 0 ? 'today' : daysSinceFirst <= 7 ? '1-7_days' : daysSinceFirst <= 30 ? '8-30_days' : '30+_days');
        }

        // ============ DEVICE & BROWSER ============
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isAndroid = /Android/i.test(navigator.userAgent);
        if (analyticsEnabled) {
          clarityTag('device_type', isMobile ? 'mobile' : 'desktop');
          clarityTag('device_os', isIOS ? 'iOS' : isAndroid ? 'Android' : 'other');
          clarityTag('screen_size', window.innerWidth <= 768 ? 'small' : window.innerWidth <= 1200 ? 'medium' : 'large');
        }

        // ============ TIME & LOCATION ============
        if (analyticsEnabled) {
          const hour = new Date().getHours();
          clarityTag('hour_of_day', hour < 6 ? 'night' : hour < 12 ? 'morning' : hour < 18 ? 'afternoon' : 'evening');
          clarityTag('day_of_week', ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][new Date().getDay()]);
          clarityTag('is_weekend', [0, 6].includes(new Date().getDay()) ? 'yes' : 'no');
          clarityTag('timezone', Intl.DateTimeFormat().resolvedOptions().timeZone);
          clarityTag('language', navigator.language);

          clarityTag('traffic_source', trafficSource);
          clarityTag('acquisition_type', acquisitionType);
          if (utmCampaign) clarityTag('utm_campaign', utmCampaign);

          // Keep original acquisition source (analytics only)
          const origSource = localStorage.getItem('acquisition_source');
          if (origSource) clarityTag('original_source', origSource);
        }

        // Persist acquisition source only for marketing attribution (marketing only)
        if (marketingEnabled) {
          localStorage.setItem('acquisition_source', trafficSource);
        }

        // ============ PAGE TRACKING ============
        const path = window.location.pathname;
        if (analyticsEnabled) {
          clarityTag('page_path', path);
          clarityTag('page_type', path === '/' ? 'homepage' : path.includes('datenschutz') || path.includes('privacy') ? 'legal' : 'subpage');

          // Page views this session
          let pageViews = parseInt(sessionStorage.getItem('page_views') || '0', 10) + 1;
          sessionStorage.setItem('page_views', pageViews.toString());
          clarityTag('pages_this_session', pageViews.toString());
        }

        // ============ ENGAGEMENT TRACKING ============
        let sessionStart = Date.now();
        let maxScroll = 0;
        let clickCount = 0;
        let downloadClicked = false;

        if (analyticsEnabled) {
          // Scroll tracking
          window.addEventListener('scroll', function() {
            const scrollPercent = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
            if (scrollPercent > maxScroll) {
              maxScroll = scrollPercent;
              clarityTag('max_scroll', maxScroll + '%');
              if (maxScroll >= 25 && maxScroll < 50) clarityEvent('scroll_25');
              else if (maxScroll >= 50 && maxScroll < 75) clarityEvent('scroll_50');
              else if (maxScroll >= 75 && maxScroll < 100) clarityEvent('scroll_75');
              else if (maxScroll >= 100) clarityEvent('scroll_100');
            }
          });

          // Time on page tracking
          setInterval(function() {
            const timeOnPage = Math.floor((Date.now() - sessionStart) / 1000);
            if (timeOnPage === 30) { clarityEvent('engaged_30s'); clarityTag('engagement_level', '30s+'); }
            if (timeOnPage === 60) { clarityEvent('engaged_60s'); clarityTag('engagement_level', '60s+'); }
            if (timeOnPage === 120) { clarityEvent('engaged_2min'); clarityTag('engagement_level', '2min+'); }
            if (timeOnPage === 300) { clarityEvent('engaged_5min'); clarityTag('engagement_level', '5min+'); }
          }, 1000);
        }

        // Click tracking
        document.addEventListener('click', function(e) {
          if (analyticsEnabled) {
            clickCount++;
            clarityTag('clicks_this_session', clickCount.toString());
          }

          const link = e.target.closest('a');
          if (!link) return;
          
          const href = link.href || '';
          const isAppStore = href.includes('apps.apple.com');
          const isPlayStore = href.includes('play.google.com');
          
          if (isAppStore || isPlayStore) {
            downloadClicked = true;
            const store = isAppStore ? 'ios' : 'android';
            
            // Marketing attribution (only if marketing consent)
            if (marketingEnabled) {
              localStorage.setItem('clicked_download', 'true');
              localStorage.setItem('download_store', store);
            }

            // Analytics signals (only if analytics consent)
            if (analyticsEnabled) {
              clarityTag('download_store', store);
              clarityEvent('download_click');
              clarityEvent('download_' + store);

              // GA4 Event (analytics)
              gaEvent('download_click', {
                store: store,
                device: isMobile ? 'mobile' : 'desktop',
                source: trafficSource || 'unknown'
              });
            }

            // Marketing conversions (only if marketing consent)
            if (marketingEnabled) {
              // Google Ads Conversion
              gaEvent('conversion', {
                send_to: 'AW-17308112458',
                event_category: 'App Download',
                event_label: store
              });

              // Meta Pixel
              fbEvent('Lead', {
                content_name: store + '_download',
                content_category: 'App Download',
                value: 1.00,
                currency: 'EUR'
              });
            }
          }
        });

        // ============ SECTION VISIBILITY ============
        if (analyticsEnabled) {
          const sectionObserver = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
              if (entry.isIntersecting) {
                const section = entry.target.id || entry.target.className.split(' ')[0];
                clarityEvent('viewed_' + section);
                clarityTag('last_section_viewed', section);
                sectionObserver.unobserve(entry.target);
              }
            });
          }, { threshold: 0.3 });

          document.querySelectorAll('section, [data-section]').forEach(function(el) {
            sectionObserver.observe(el);
          });
        }

        // ============ EXIT INTENT ============
        if (analyticsEnabled) {
          let exitIntentShown = false;
          document.addEventListener('mouseout', function(e) {
            if (e.clientY < 10 && !exitIntentShown && !downloadClicked) {
              exitIntentShown = true;
              clarityEvent('exit_intent');
              clarityTag('showed_exit_intent', 'yes');
            }
          });
        }

        // ============ PAGE UNLOAD METRICS ============
        if (analyticsEnabled) {
          window.addEventListener('beforeunload', function() {
            const timeOnPage = Math.floor((Date.now() - sessionStart) / 1000);
            clarityTag('final_time_on_page', timeOnPage + 's');
            clarityTag('final_scroll_depth', maxScroll + '%');
            clarityTag('final_click_count', clickCount.toString());
            clarityTag('did_convert', downloadClicked ? 'yes' : 'no');
            
            // Engagement score (0-100)
            let score = 0;
            if (timeOnPage > 30) score += 20;
            if (timeOnPage > 120) score += 20;
            if (maxScroll > 50) score += 20;
            if (maxScroll > 90) score += 10;
            if (clickCount > 3) score += 10;
            if (downloadClicked) score += 20;
            clarityTag('engagement_score', score.toString());
          });
        }

        // Check if returning converter
        if (analyticsEnabled && localStorage.getItem('clicked_download') === 'true') {
          clarityTag('returning_converter', 'yes');
        }
      });
    </script>
  </body>
</html>
