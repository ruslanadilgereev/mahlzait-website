---
import type { TemplateConfig } from "utils/configType";
import { generateWebsiteSchema } from "./schemas/website";
import { generateOrganizationSchema } from "./schemas/organization";
import { generateMobileAppSchema } from "./schemas/mobileApp";
import { generateFAQSchema } from "./schemas/faq";
import { generateReviewSchema } from "./schemas/review";
import { generateHowToSchema } from "./schemas/howto";
import { generateBreadcrumbSchema } from "./schemas/breadcrumb";
import { generateProductSchemas } from "./schemas/product";
import { generateWebPageSchema } from "./schemas/webpage";

interface Props {
  config: TemplateConfig;
  type?: "homepage" | "page";
  pageTitle?: string;
  pageDescription?: string;
}

const { config, type = "page", pageTitle, pageDescription } = Astro.props;
const siteUrl = "https://www.mahlzait.de";
const currentUrl = new URL(Astro.url.pathname, siteUrl).href;

// Basis-Schemas für alle Seiten
const websiteSchema = generateWebsiteSchema(
  siteUrl,
  config.name,
  config.seo.description
);

const organizationSchema = generateOrganizationSchema(
  siteUrl,
  config.name,
  new URL(config.logo, siteUrl).href
);

const mobileAppSchema = generateMobileAppSchema(
  siteUrl,
  config.name,
  config.seo.description,
  config.appStoreLink,
  config.googlePlayLink
);

// Homepage-spezifische Schemas
let faqSchema = null;
let reviewSchemas = null;
let howToSchema = null;
let breadcrumbSchema = null;
let productSchemas = null;
let webPageSchema = null;

if (type === "homepage" && config.home) {
  // FAQ Schema
  if (config.home.faq) {
    faqSchema = generateFAQSchema(
      siteUrl,
      config.home.faq.qa.map((item) => ({
        question: item.question,
        answer: item.answer,
      }))
    );
  }

  // Review Schemas
  if (config.home.testimonials) {
    reviewSchemas = generateReviewSchema(
      siteUrl,
      config.home.testimonials.cards.map((card) => ({
        name: card.name,
        comment: card.comment,
      }))
    );
  }

  // HowTo Schema - REMOVED (deprecated by Google since Sept 2023)
  // if (config.home.howItWorks) {
  //   howToSchema = generateHowToSchema(
  //     siteUrl,
  //     config.home.howItWorks.title,
  //     config.home.howItWorks.subtitle,
  //     config.home.howItWorks.steps
  //   );
  // }

  // Product Schemas für Preismodelle
  productSchemas = generateProductSchemas(siteUrl, config.name, [
    {
      name: "Kostenlos",
      description: "Kostenlose Version mit Basis-Features",
      price: "0",
    },
    {
      name: "Pro Monat",
      description: "Monatliches Abo mit allen Premium-Features und unbegrenzter KI",
      price: "4.99",
      billingPeriod: "month",
    },
    {
      name: "Pro Jahr",
      description: "Jahresabo mit allen Premium-Features - spare 50%",
      price: "29.99",
      billingPeriod: "year",
    },
  ]);

  // Breadcrumb für Homepage
  breadcrumbSchema = generateBreadcrumbSchema([
    { name: "Home", url: siteUrl },
  ]);
  
  // WebPage Schema für Homepage
  webPageSchema = generateWebPageSchema({
    url: currentUrl,
    name: config.seo.title,
    description: config.seo.description,
  });
} else {
  // Breadcrumb für andere Seiten
  breadcrumbSchema = generateBreadcrumbSchema([
    { name: "Home", url: siteUrl },
    { name: pageTitle || "Seite", url: currentUrl },
  ]);
  
  // WebPage Schema für alle anderen Seiten
  webPageSchema = generateWebPageSchema({
    url: currentUrl,
    name: pageTitle || config.seo.title,
    description: pageDescription || config.seo.description,
  });
}

// Alle Schemas kombinieren
const allSchemas = [
  websiteSchema,
  organizationSchema,
  mobileAppSchema,
  breadcrumbSchema,
];

if (faqSchema) allSchemas.push(faqSchema);
if (howToSchema) allSchemas.push(howToSchema);
if (reviewSchemas) allSchemas.push(...reviewSchemas);
if (productSchemas) allSchemas.push(...productSchemas);
if (webPageSchema) allSchemas.push(webPageSchema);
---

{
  allSchemas.map((schema) => (
    <script type="application/ld+json" set:html={JSON.stringify(schema)} />
  ))
}

